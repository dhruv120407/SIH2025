<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AttendWise — Multi Division</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root{
      --primary:#7f5af0;
      --secondary:#2cb67d;
      --accent:#3a86ff;
      --danger:#ff006e;
      --muted:#94a3b8;
      --text-light:#e2e8f0;
      --text-dark:#1e293b;
      --shadow:rgba(0,0,0,0.3);
    }
    html.light{
      --primary:#3a86ff;
      --secondary:#ffbe0b;
      --accent:#ff006e;
      --danger:#ef233c;
      --muted:#64748b;
      --text-light:#1e293b;
      --text-dark:#f8fafc;
      --shadow:rgba(50,50,50,0.2);
    }

    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: linear-gradient(-45deg, var(--primary), var(--secondary), var(--accent), var(--danger));
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
      color: var(--text-light);
      min-height: 100vh;
      margin: 0;
      transition: background .5s, color .5s;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .card {
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 1rem;
      box-shadow: 0 8px 24px var(--shadow);
      transition: all .4s ease;
    }
    .card:hover {
      transform: translateY(-6px);
      box-shadow: 0 12px 36px var(--shadow);
    }

    .btn {
      padding: .6rem 1rem;
      border-radius: .5rem;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      color: white;
      font-weight: 600;
      transition: all .3s ease;
    }
    .btn:hover {
      transform: scale(1.08);
      box-shadow: 0 0 20px rgba(127, 90, 240, 0.7);
    }
    .btn:active {
      transform: scale(0.95);
      box-shadow: 0 2px 8px var(--shadow);
    }

    .fade-in {
      animation: fadeInUp .6s ease forwards;
      opacity: 0;
      transform: translateY(20px);
    }
    @keyframes fadeInUp {
      to { opacity: 1; transform: translateY(0); }
    }

    .nav-item i {
      transition: transform .3s ease, color .3s ease;
    }
    .nav-item:hover i {
      transform: scale(1.2);
      color: var(--accent);
    }

    #video,#overlay{position:absolute;top:0;left:0;border-radius:.5rem}
</style>
</head>
<body>
  <main id="login-screen" class="min-h-screen flex items-center justify-center p-6">
    <section class="max-w-md w-full card rounded-xl p-8 shadow-2xl">
      <div class="text-center">
        <div class="mx-auto w-14 h-14 rounded-full flex items-center justify-center bg-blue-600 text-white shadow-lg"><i class="fas fa-user-check fa-lg"></i></div>
        <h1 class="mt-4 text-3xl font-bold">AttendWise</h1>
        <p class="text-sm text-[color:var(--muted)]" id="login-sub">Teacher Login</p>
      </div>
      <form id="login-form" class="mt-8 space-y-4" aria-label="Teacher login form">
        <input id="username" name="username" required class="w-full p-3 rounded-md bg-[color:var(--bg)] border border-[color:var(--border)]" placeholder="Username">
        <div class="relative">
          <input id="password" name="password" type="password" required class="w-full p-3 rounded-md bg-[color:var(--bg)] border border-[color:var(--border)]" placeholder="Password">
          <button id="password-toggle" type="button" class="absolute right-3 top-3.5 text-[color:var(--muted)]" aria-label="Toggle password visibility"><i class="fas fa-eye"></i></button>
        </div>
        <p id="login-error" class="text-sm text-red-500 h-5"></p>
        <div class="flex gap-3 pt-2">
          <button type="submit" class="flex-1 bg-[color:var(--accent)] text-white p-3 rounded-md font-semibold hover:bg-blue-500 btn">Sign in</button>
          <button id="reset-creds" type="button" class="flex-1 bg-gray-600 text-white p-3 rounded-md small hover:bg-gray-500 btn">Reset Demo Creds</button>
        </div>
      </form>
     </form> </section>
    </section>
  </main>

  <div id="app" class="hidden min-h-screen flex">
    <aside class="hidden md:flex flex-col w-20 p-4 gap-6 items-center justify-between card !border-l-0 !border-t-0 !border-b-0 !rounded-none">
      <div class="space-y-6 text-center text-[color:var(--accent)]">
        <i class="fas fa-user-shield fa-2x"></i>
      </div>
      <nav class="flex flex-col gap-6" aria-label="Main nav">
        <a href="#" class="nav-item" data-page="dashboard" title="Dashboard"><i class="fas fa-th-large fa-lg"></i></a>
        <a href="#" class="nav-item" data-page="clock" title="Clock In/Out"><i class="fas fa-camera fa-lg"></i></a>
        <a href="#" class="nav-item" data-page="users" title="Students"><i class="fas fa-users-cog fa-lg"></i></a>
        <a href="#" class="nav-item" data-page="logs" title="Logs"><i class="fas fa-clipboard-list fa-lg"></i></a>
        <a href="#" class="nav-item" data-page="timetable" title="Timetable"><i class="fas fa-calendar-alt fa-lg"></i></a>
        <a href="#" class="nav-item" data-page="settings" title="Settings"><i class="fas fa-cog fa-lg"></i></a>
      </nav>
      <div class="flex flex-col items-center gap-4">
        <button id="theme-toggle" class="text-[color:var(--muted)] hover:text-[color:var(--accent)] transition-colors" title="Toggle Theme">
        <i class="fas fa-moon"></i>
      </button>
        <button id="logout" class="text-[color:var(--muted)] hover:text-[color:var(--accent)] transition-colors" title="Logout"><i class="fas fa-sign-out-alt fa-lg"></i></button>
        <div id="current-division" class="text-sm text-[color:var(--muted)]"></div>
      </div>
    </aside>

    <main id="main" class="flex-1 p-6 md:p-10 overflow-auto"></main>

    <nav class="md:hidden fixed bottom-0 left-0 right-0 h-16 flex items-center justify-around z-40 card !border-b-0 !border-l-0 !border-r-0 !rounded-none">
      <a href="#" class="nav-item" data-page="dashboard"><i class="fas fa-th-large"></i></a>
      <a href="#" class="nav-item" data-page="clock"><i class="fas fa-camera"></i></a>
      <a href="#" class="nav-item" data-page="users"><i class="fas fa-users-cog"></i></a>
      <a href="#" class="nav-item" data-page="logs"><i class="fas fa-clipboard-list"></i></a>
      <a href="#" class="nav-item" data-page="timetable"><i class="fas fa-calendar-alt"></i></a>
      <a href="#" class="nav-item" data-page="settings"><i class="fas fa-cog"></i></a>
      <button id="theme-toggle-mobile" class="nav-item">
        <i class="fas fa-moon"></i>
      </button>

    </nav>
  </div>

  <!-- Loading, Modals, Alerts (unchanged) -->
  <div id="loading" class="hidden fixed inset-0 flex items-center justify-center bg-black/60 z-50">
    <div class="p-6 rounded-lg text-center">
      <div class="loader mb-4 mx-auto" style="width:48px;height:48px;border-radius:50%;position:relative;animation:rotate 1s linear infinite"></div>
      <h3 id="loading-title" class="font-semibold text-lg text-white">Loading</h3>
      <p id="loading-sub" class="text-sm text-gray-300"></p>
    </div>
  </div>

  <div id="pin-modal" class="hidden fixed inset-0 flex items-center justify-center bg-black/70 z-50 p-4">
    <div class="card rounded-lg p-6 w-full max-w-sm">
      <h3 class="text-lg font-semibold text-center">Verify Roll Number</h3>
      <p class="text-center text-sm">Face recognized: <strong id="pin-name"></strong></p>
      <form id="pin-form" class="mt-4">
        <input id="pin" inputmode="numeric" autocomplete="one-time-code" class="w-full p-3 rounded-md text-center text-2xl tracking-widest bg-[color:var(--bg)] border border-[color:var(--border)]" placeholder="_ _ _ _" required>
        <p id="pin-err" class="text-sm text-red-500 h-5 mt-2 text-center"></p>
        <div class="mt-4 flex gap-3">
          <button type="button" id="pin-cancel" class="flex-1 p-2 rounded-md bg-gray-600 hover:bg-gray-500 text-white btn">Cancel</button>
          <button type="submit" class="flex-1 p-2 rounded-md bg-[color:var(--accent)] hover:bg-blue-500 text-white btn">Verify</button>
        </div>
      </form>
    </div>
  </div>

  <div id="alert" class="hidden fixed inset-0 flex items-center justify-center bg-black/70 z-50 p-4">
    <div class="card rounded-lg p-6 w-full max-w-sm text-center">
      <h3 id="alert-title" class="font-semibold text-lg"></h3>
      <p id="alert-msg" class="text-sm mt-2 text-[color:var(--muted)]"></p>
      <div class="mt-6"><button id="alert-ok" class="p-2 rounded-md bg-[color:var(--accent)] hover:bg-blue-500 text-white w-1/2 btn">OK</button></div>
    </div>
  </div>

  <div id="confirm" class="hidden fixed inset-0 flex items-center justify-center bg-black/70 z-50 p-4">
    <div class="card rounded-lg p-6 w-full max-w-sm text-center">
      <h3 id="confirm-title" class="font-semibold text-lg">Confirm</h3>
      <p id="confirm-msg" class="text-sm mt-2 text-[color:var(--muted)]"></p>
      <div class="mt-6 flex gap-3">
        <button id="confirm-no" class="flex-1 p-2 rounded-md bg-gray-600 hover:bg-gray-500 text-white btn">Cancel</button>
        <button id="confirm-yes" class="flex-1 p-2 rounded-md bg-red-600 hover:bg-red-500 text-white btn">Confirm</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   STATE & STORAGE
   ========================= */
const STATE = {
  users: [], // {id,name,roll,division,image,descriptor(Array)}
  attendance: [], // {id,name,division,subject,date,time,status}
  timetable: [], // {id, subject, day, startTime, endTime, division?}
  faceMatcher: null,
  modelsLoaded: false,
  recogInterval: null,
  verifying: false,
  pendingUser: null,
  cooldownMap: new Map(),
  videoStream: null
};
const DBKEY = 'attendwise_multidiv_v2';

/* ---------- Elements ---------- */
const els = {
  loginScreen: document.getElementById('login-screen'),
  app: document.getElementById('app'),
  main: document.getElementById('main'),
  loading: document.getElementById('loading'),
  loadingTitle: document.getElementById('loading-title'),
  loadingSub: document.getElementById('loading-sub'),
  pinModal: document.getElementById('pin-modal'),
  pinName: document.getElementById('pin-name'),
  pinForm: document.getElementById('pin-form'),
  pinInput: document.getElementById('pin'),
  pinErr: document.getElementById('pin-err'),
  pinCancel: document.getElementById('pin-cancel'),
  alert: document.getElementById('alert'),
  alertTitle: document.getElementById('alert-title'),
  alertMsg: document.getElementById('alert-msg'),
  alertOk: document.getElementById('alert-ok'),
  confirm: document.getElementById('confirm'),
  confirmMsg: document.getElementById('confirm-msg'),
  confirmYes: document.getElementById('confirm-yes'),
  confirmNo: document.getElementById('confirm-no'),
  currentDivision: document.getElementById('current-division')
};

/* ---------- Storage Helpers ---------- */
function loadDB(){
  const raw = localStorage.getItem(DBKEY);
  if(!raw){
    STATE.users = [];
    STATE.attendance = [];
    STATE.timetable = [];
    return;
  }
  try{
    const parsed = JSON.parse(raw);
    // Backwards compatibility: if old users don't have division, default to 'A'
    STATE.users = (parsed.users || []).map(u => ({ ...u, division: u.division || 'A' }));
    STATE.attendance = parsed.attendance || [];
    STATE.timetable = parsed.timetable || [];
  }catch(e){
    console.error("Failed to parse DB", e);
    STATE.users = []; STATE.attendance = []; STATE.timetable = [];
  }
}
function saveDB(){
  try {
    localStorage.setItem(DBKEY, JSON.stringify({ users: STATE.users, attendance: STATE.attendance, timetable: STATE.timetable }));
  } catch(e){
    console.error('Save error', e); showAlert('Storage Error','Could not save data. Storage may be full.');
  }
}

/* ---------- Teachers Initialization ---------- */
function initTeachers(){
  if(!localStorage.getItem('teachers')){
    const teachers = [
      { username:'teacherA', password:'passA', division:'A' },
      { username:'teacherB', password:'passB', division:'B' },
      { username:'teacherC', password:'passC', division:'C' },
      { username:'teacherD', password:'passD', division:'D' }
    ];
    localStorage.setItem('teachers', JSON.stringify(teachers));
  }
}
initTeachers();

/* ========== Initialization ========== */
document.addEventListener('DOMContentLoaded', async ()=>{
  attachStaticListeners();
  loadDB();
  await loadModels();
  // don't build global matcher yet — build per-division on login/showPage
  checkAuthAndShow();
  showPage('dashboard');
  setInterval(()=>{ const lc = document.getElementById('live-clock'); if(lc) lc.textContent = new Date().toLocaleTimeString(); }, 1000);
});

/* ---------- Static Listeners ---------- */
function attachStaticListeners(){
  document.getElementById('login-form').addEventListener('submit', handleLogin);
  document.getElementById('password-toggle').addEventListener('click', ()=>{
    const p = document.getElementById('password'), i = document.querySelector('#password-toggle i');
    if(p.type==='password'){ p.type='text'; i.classList.replace('fa-eye','fa-eye-slash'); } else { p.type='password'; i.classList.replace('fa-eye-slash','fa-eye'); }
  });
  document.querySelectorAll('.nav-item').forEach(a=> a.addEventListener('click', e=>{ e.preventDefault(); showPage(a.dataset.page); }));
  document.getElementById('logout').addEventListener('click', handleLogout);
  document.getElementById('reset-creds').addEventListener('click', ()=> {
    initTeachers(); showAlert('Reset','Demo credentials re-initialized.');
  });

  els.pinCancel.addEventListener('click', cancelPin);
  els.pinForm.addEventListener('submit', submitPin);
  els.alertOk.addEventListener('click', ()=> els.alert.classList.add('hidden'));
  els.confirmNo.addEventListener('click', ()=> closeConfirm(false));
  els.confirmYes.addEventListener('click', ()=> closeConfirm(true));
}

/* ---------- Login / Auth ---------- */
function handleLogin(e){
  e.preventDefault();
  const u = e.target.username.value.trim();
  const p = e.target.password.value;
  const teachers = JSON.parse(localStorage.getItem('teachers') || '[]');
  const teacher = teachers.find(t => t.username === u && t.password === p);
  if(teacher){
    localStorage.setItem('isLoggedIn','true');
    localStorage.setItem('currentTeacher', JSON.stringify(teacher));
    checkAuthAndShow();
    e.target.reset();
  } else {
    const err = document.getElementById('login-error'); err.textContent = 'Invalid credentials'; setTimeout(()=>err.textContent='',2000);
  }
}
function checkAuthAndShow(){
  const currentTeacher = getCurrentTeacher();
  if(currentTeacher){
    els.loginScreen.classList.add('hidden'); els.app.classList.remove('hidden');
    els.currentDivision.textContent = `Division: ${currentTeacher.division}`;
  } else {
    els.loginScreen.classList.remove('hidden'); els.app.classList.add('hidden');
  }
}
function handleLogout(){
  stopRecognition();
  localStorage.removeItem('isLoggedIn'); localStorage.removeItem('currentTeacher');
  checkAuthAndShow(); showPage('dashboard');
}
function getCurrentTeacher(){
  try{ return JSON.parse(localStorage.getItem('currentTeacher') || 'null'); }catch(e){ return null; }
}

/* ---------- Alerts & Confirm ---------- */
function showAlert(title,msg){
  els.alertTitle.textContent = title; els.alertMsg.textContent = msg; els.alert.classList.remove('hidden');
}
let confirmResolver = null;
function showConfirm(msg){
  els.confirmMsg.textContent = msg; els.confirm.classList.remove('hidden');
  return new Promise(res => { confirmResolver = res; });
}
function closeConfirm(answer){
  els.confirm.classList.add('hidden'); if(confirmResolver) confirmResolver(answer); confirmResolver = null;
}

/* ---------- Loading UI ---------- */
function showLoading(title, sub=''){ els.loadingTitle.textContent = title; els.loadingSub.textContent = sub; els.loading.classList.remove('hidden'); }
function hideLoading(){ els.loading.classList.add('hidden'); }

/* ========= Face API Models & Matcher ========= */
const MODEL_URL = 'https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights';
const tinyFaceDetectorOptions = new faceapi.TinyFaceDetectorOptions();

async function loadModels(){
  try{
    showLoading('Loading models','This may take a moment...');
    await Promise.all([
      faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
      faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
      faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
    ]);
    STATE.modelsLoaded = true;
  }catch(e){
    console.error('model load', e);
    showAlert('Model error','Could not load face models. Check network.');
  } finally { hideLoading(); }
}

function rebuildMatcherForCurrentDivision(){
  const currentTeacher = getCurrentTeacher();
  const division = currentTeacher ? currentTeacher.division : null;
  const students = division ? STATE.users.filter(u => u.division === division) : [];
  if(!students || students.length === 0){ STATE.faceMatcher = null; return; }
  try{
    const labeled = students.map(u => {
      const arr = new Float32Array(u.descriptor);
      return new faceapi.LabeledFaceDescriptors(u.name, [arr]);
    });
    STATE.faceMatcher = new faceapi.FaceMatcher(labeled, 0.55);
  }catch(e){
    console.error('matcher', e);
    STATE.faceMatcher = null;
  }
}

/* ========= Templates & Page Setup ========= */
const templates = {
  dashboard: () => {
    const currentTeacher = getCurrentTeacher();
    const division = currentTeacher ? currentTeacher.division : null;
    const today = new Date().toISOString().slice(0,10);
    const users = division ? STATE.users.filter(u => u.division === division) : [];
    const presentSet = new Set(STATE.attendance.filter(a => a.date === today && a.division === division).map(a=>a.name));
    const total = users.length;
    const present = presentSet.size;
    const absent = Math.max(0, total - present);
    return `
      <div class="fade-in">
        <div class="flex justify-between items-center mb-6">
          <div><h2 class="text-3xl font-bold">Dashboard — Division ${division || 'N/A'}</h2><p id="today-date" class="text-sm text-[color:var(--muted)]">${new Date().toLocaleDateString(undefined,{weekday:'long',year:'numeric',month:'long',day:'numeric'})}</p></div>
          <div id="live-clock" class="font-medium text-lg">${new Date().toLocaleTimeString()}</div>
        </div>
        <div class="grid md:grid-cols-3 gap-6">
          <div class="card p-6 rounded-lg flex items-center gap-4"><i class="fas fa-users fa-2x text-blue-400"></i><div><h4 class="text-sm text-[color:var(--muted)]">Total Students</h4><div class="text-2xl font-bold">${total}</div></div></div>
          <div class="card p-6 rounded-lg flex items-center gap-4"><i class="fas fa-user-check fa-2x text-green-400"></i><div><h4 class="text-sm text-[color:var(--muted)]">Present Today</h4><div class="text-2xl font-bold">${present}</div></div></div>
          <div class="card p-6 rounded-lg flex items-center gap-4"><i class="fas fa-user-times fa-2x text-red-400"></i><div><h4 class="text-sm text-[color:var(--muted)]">Absent Today</h4><div class="text-2xl font-bold">${absent}</div></div></div>
        </div>

        <div class="grid md:grid-cols-2 gap-6 mt-6">
          <div class="card p-4 rounded-lg">
            <h4 class="font-semibold mb-3">Recent Activity</h4>
            <div id="recent-list" class="text-sm max-h-60 overflow-auto space-y-2">
              ${STATE.attendance.filter(a=>a.date===today && a.division===division).slice(-8).reverse().map(r=>`<div class="flex justify-between p-2 rounded-md bg-[color:var(--bg)]"><div><strong>${r.name}</strong><div class="text-xs text-[color:var(--muted)]">${r.subject}</div></div><div class="text-sm">${r.time}</div></div>`).join('') || '<div class="text-[color:var(--muted)] text-center p-4">No activity today</div>'}
            </div>
          </div>

          <div class="card p-4 rounded-lg">
            <h4 class="font-semibold mb-3">Today's Schedule</h4>
            <div id="schedule-status" class="text-sm p-4 rounded-md bg-[color:var(--bg)]">${getCurrentClassInfo().text}</div>
            ${getCurrentClassInfo().subject ? `<button id="quick-start-session" data-subject="${getCurrentClassInfo().subject}" class="mt-4 w-full p-2 rounded-md bg-blue-600 hover:bg-blue-500 text-white text-sm font-semibold btn">Start '${getCurrentClassInfo().subject}' Session</button>` : ''}
          </div>
        </div>
      </div>
    `;
  },

  users: () => {
    return `
      <div class="fade-in">
        <h2 class="text-3xl font-bold mb-6">Manage Students</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <section class="card p-4 rounded-lg">
            <h3 class="font-semibold mb-4">Add Student (Automatically tagged to your division)</h3>
            <form id="add-user-form" class="space-y-4">
              <input id="name" placeholder="Name" class="w-full p-2 rounded-md bg-[color:var(--bg)] border border-[color:var(--border)]" required>
              <input id="roll" placeholder="Roll Number" class="w-full p-2 rounded-md bg-[color:var(--bg)] border border-[color:var(--border)]" required>
              <div class="flex gap-2 items-center">
                <label for="file-image" class="flex-1 btn bg-gray-600 text-white text-center cursor-pointer">Select Image</label>
                <input id="file-image" type="file" accept="image/*" class="sr-only">
                <button id="capture-btn" type="button" class="btn bg-[color:var(--accent)] text-white">Webcam</button>
              </div>
              <div id="capture-area" class="hidden mt-2 relative" style="padding-top:56%;border-radius:8px;overflow:hidden;background:#000">
                <video id="capture-video" autoplay muted playsinline style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover"></video>
                <canvas id="capture-canvas" style="position:absolute;inset:0;width:100%;height:100%"></canvas>
                <div class="absolute bottom-2 left-2 right-2 flex gap-2">
                  <button id="snap" type="button" class="flex-1 btn bg-green-600 text-white">Snap</button>
                  <button id="stop-capture" type="button" class="flex-1 btn bg-gray-600 text-white">Stop</button>
                </div>
              </div>
              <button id="add-btn" class="w-full p-2 rounded-md bg-[color:var(--accent)] hover:bg-blue-500 text-white btn" type="submit">Add Student</button>
            </form>
          </section>

          <section class="card p-4 rounded-lg">
            <h3 class="font-semibold mb-4">Registered Students</h3>
            <div id="user-list" class="grid grid-cols-2 sm:grid-cols-3 gap-3 max-h-96 overflow-auto"></div>
            <div class="mt-4 flex gap-2">
              <button id="export-db" class="flex-1 btn bg-green-600 hover:bg-green-500 text-white">Export JSON</button>
              <button id="import-db" class="flex-1 btn bg-yellow-600 hover:bg-yellow-500 text-white">Import JSON</button>
              <input id="import-file" type="file" accept="application/json" class="hidden">
            </div>
          </section>
        </div>
      </div>
    `;
  },

  logs: () => {
    const d = new Date().toISOString().slice(0,10);
    return `
      <div class="fade-in">
        <h2 class="text-3xl font-bold mb-6">Attendance Log</h2>
        <div class="card p-4 rounded-lg">
          <div class="flex flex-wrap gap-3 mb-4">
            <input id="log-date" type="date" value="${d}" class="p-2 rounded-md bg-[color:var(--bg)] border border-[color:var(--border)]">
            <button id="download-csv" class="p-2 rounded-md bg-green-600 hover:bg-green-500 text-white btn">Download CSV</button>
            <button id="clear-attendance" class="p-2 rounded-md bg-red-600 hover:bg-red-500 text-white btn">Clear All (Division)</button>
          </div>
          <div class="overflow-auto"><table class="w-full text-sm"><thead><tr class="border-b border-[color:var(--border)]"><th class="p-2 text-left">Name</th><th class="p-2 text-left">Date</th><th class="p-2 text-left">Subject</th><th class="p-2 text-left">Time</th><th class="p-2 text-left">Status</th></tr></thead><tbody id="log-body"></tbody></table></div>
        </div>
      </div>
    `;
  },

  timetable: () => {
    return `
      <div class="fade-in">
        <h2 class="text-3xl font-bold mb-6">Timetable</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <section class="md:col-span-1 card p-4 rounded-lg">
            <h3 class="font-semibold mb-4">Add Schedule (for your division)</h3>
            <form id="add-schedule-form" class="space-y-4">
              <input id="tt-subject" placeholder="Subject Name" class="w-full p-2 rounded-md bg-[color:var(--bg)] border border-[color:var(--border)]" required>
              <select id="tt-day" class="w-full p-2 rounded-md bg-[color:var(--bg)] border border-[color:var(--border)]" required>
                <option value="" disabled selected>Select Day</option>
                <option value="1">Monday</option><option value="2">Tuesday</option><option value="3">Wednesday</option><option value="4">Thursday</option><option value="5">Friday</option><option value="6">Saturday</option><option value="0">Sunday</option>
              </select>
              <div class="flex gap-2">
                <div class="flex-1"><label for="tt-start-time" class="text-xs text-[color:var(--muted)]">Start Time</label><input id="tt-start-time" type="time" class="w-full p-2 rounded-md bg-[color:var(--bg)] border border-[color:var(--border)]" required></div>
                <div class="flex-1"><label for="tt-end-time" class="text-xs text-[color:var(--muted)]">End Time</label><input id="tt-end-time" type="time" class="w-full p-2 rounded-md bg-[color:var(--bg)] border border-[color:var(--border)]" required></div>
              </div>
              <button class="w-full p-2 rounded-md bg-[color:var(--accent)] hover:bg-blue-500 text-white btn" type="submit">Add to Timetable</button>
            </form>
          </section>

          <section class="md:col-span-2 card p-4 rounded-lg max-h-[80vh] overflow-auto">
            <h3 class="font-semibold mb-4">Weekly Schedule (Your Division)</h3>
            <div id="timetable-display" class="space-y-4"></div>
          </section>
        </div>
      </div>
    `;
  },

  settings: () => {
    return `
      <div class="fade-in">
        <h2 class="text-3xl font-bold mb-6">Settings</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <section class="card p-4 rounded-lg">
            <h3 class="font-semibold mb-4">Change My Password</h3>
            <form id="cred-form" class="space-y-3">
              <input id="cur-pass" placeholder="Current password" type="password" class="w-full p-2 rounded-md bg-[color:var(--bg)] border border-[color:var(--border)]" required>
              <input id="new-pass" placeholder="New password" type="password" class="w-full p-2 rounded-md bg-[color:var(--bg)] border border-[color:var(--border)]" required>
              <button class="w-full p-2 rounded-md bg-[color:var(--accent)] hover:bg-blue-500 text-white btn" type="submit">Save Changes</button>
            </form>
          </section>
          <section class="card p-4 rounded-lg">
            <h3 class="font-semibold mb-4 text-red-500">Danger Zone</h3>
            <div class="space-y-3">
              <p class="text-sm text-[color:var(--muted)]">These actions are irreversible for your division only.</p>
              <button id="clear-users" class="w-full p-2 rounded-md bg-red-600 hover:bg-red-500 text-white btn">Delete All My Students</button>
            </div>
          </section>
        </div>
      </div>
    `;
  },

  clock: () => {
    return `
      <div class="fade-in">
        <h2 class="text-3xl font-bold mb-6">Clock In / Out</h2>
        <div class="card p-4 rounded-lg">
          <div id="session-setup">
            <input id="subject" placeholder="Enter subject name..." class="w-full p-2 rounded-md bg-[color:var(--bg)] border border-[color:var(--border)]"><button id="start-btn" class="mt-3 w-full p-2 rounded-md bg-[color:var(--accent)] hover:bg-blue-500 text-white btn">Start Session</button>
          </div>

          <div id="session-run" class="hidden mt-4 space-y-4">
            <div class="flex justify-between items-center p-2 rounded-md bg-[color:var(--bg)]">
              <div><strong>Subject:</strong> <span id="active-subject"></span></div>
              <div class="flex gap-2">
                <button id="stop-btn" class="p-2 rounded-md bg-red-600 hover:bg-red-500 text-white btn">Stop</button>
                <button id="pause-btn" class="p-2 rounded-md bg-gray-600 hover:bg-gray-500 text-white btn">Pause</button>
              </div>
            </div>

            <div class="relative w-full" style="padding-top:56.25%;background:#000;border-radius:.5rem;overflow:hidden">
              <video id="video" autoplay muted playsinline style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover"></video>
              <canvas id="overlay" style="position:absolute;inset:0;width:100%;height:100%"></canvas>
            </div>

            <div id="recognition-log" class="max-h-48 overflow-auto p-2 text-sm rounded-md bg-[color:var(--bg)]"></div>
          </div>
        </div>
      </div>
    `;
  }
};

/* ---------- Show Page ---------- */
function showPage(page){
  if (window.dashboardInterval) { clearInterval(window.dashboardInterval); window.dashboardInterval = null; }
  if(page !== 'dashboard' && !STATE.modelsLoaded){ showAlert('Please wait','Face models are still loading'); return; }

  rebuildMatcherForCurrentDivision();
  const content = templates[page] ? templates[page]() : '<div>Not found</div>';
  els.main.innerHTML = content;
  document.querySelectorAll('.nav-item').forEach(a => a.classList.toggle('text-[color:var(--accent)]', a.dataset.page === page));

  // Hook page-specific setup
  if(page === 'users') setupUsersPage();
  if(page === 'logs') setupLogsPage();
  if(page === 'settings') setupSettingsPage();
  if(page === 'clock') setupClockPage();
  if(page === 'timetable') setupTimetablePage();
  if(page === 'dashboard') setupDashboardPage();
}

/* ========= Dashboard Logic ========= */
function setupDashboardPage() {
  const quickStartBtn = document.getElementById('quick-start-session');
  if (quickStartBtn) {
    quickStartBtn.addEventListener('click', (e) => {
      const subject = e.target.dataset.subject;
      showPage('clock');
      setTimeout(() => {
        const subjectInput = document.getElementById('subject');
        if (subjectInput) { subjectInput.value = subject; document.getElementById('start-btn').click(); }
      }, 100);
    });
  }
  if (document.getElementById('schedule-status')) {
    window.dashboardInterval = setInterval(() => {
      const statusEl = document.getElementById('schedule-status');
      if (statusEl) { statusEl.innerHTML = getCurrentClassInfo().text; }
    }, 60 * 1000);
  }
}

/* ========= Users Page ========= */
function setupUsersPage(){
  renderUserList();

  const form = document.getElementById('add-user-form');
  const fileInput = document.getElementById('file-image');
  form.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    const name = document.getElementById('name').value.trim();
    const roll = document.getElementById('roll').value.trim();
    const currentTeacher = getCurrentTeacher();
    if(!currentTeacher){ showAlert('Error','No teacher logged in'); return; }
    const division = currentTeacher.division;

    if(!name || !roll) { showAlert('Error','Name and roll required'); return; }
    if(STATE.users.some(u=>u.roll === roll && u.division === division)){ showAlert('Error','A student with this roll already exists in your division.'); return; }

    const file = fileInput.files && fileInput.files[0];
    let imgElement;
    try{
      showLoading('Processing','Detecting face...');
      if(file){
        imgElement = await faceapi.bufferToImage(file);
      } else if(lastSnapDataUrl){
        imgElement = await faceapi.fetchImage(lastSnapDataUrl);
      } else {
        showAlert('Error','Please upload an image or capture one using the webcam.');
        return;
      }
      const detection = await faceapi.detectSingleFace(imgElement, tinyFaceDetectorOptions).withFaceLandmarks().withFaceDescriptor();
      if(!detection){ showAlert('No Face Detected','Could not detect a clear face in the image. Please try another one.'); return; }

      const descriptorArr = Array.from(detection.descriptor);
      const rawDataUrl = file ? await fileToDataURL(file) : lastSnapDataUrl;
      const resizedDataUrl = await resizeImage(rawDataUrl, 200);

      const user = { id: Date.now().toString(), name, roll, division, image: resizedDataUrl, descriptor: descriptorArr };
      STATE.users.push(user); saveDB(); rebuildMatcherForCurrentDivision(); renderUserList();
      showAlert('Success', `${name} has been added to Division ${division}.`);
      form.reset(); lastSnapDataUrl = null;
    }catch(err){
      console.error(err); showAlert('Error','An unexpected error occurred while adding the student.');
    }finally{
      hideLoading();
      stopCaptureIfAny();
    }
  });

  document.getElementById('capture-btn').addEventListener('click', startCapture);
  document.getElementById('snap').addEventListener('click', snapAndShow);
  document.getElementById('stop-capture').addEventListener('click', stopCaptureIfAny);
  document.getElementById('export-db').addEventListener('click', exportJSON);
  document.getElementById('import-db').addEventListener('click', ()=> document.getElementById('import-file').click());
  document.getElementById('import-file').addEventListener('change', importJSONFromFile);
}

function renderUserList(){
  const list = document.getElementById('user-list');
  if(!list) return;
  const currentTeacher = getCurrentTeacher();
  const division = currentTeacher ? currentTeacher.division : null;
  const users = STATE.users.filter(u => u.division === division);
  if(users.length === 0){ list.innerHTML = '<div class="text-[color:var(--muted)] col-span-full text-center p-4">No students registered yet.</div>'; return; }
  list.innerHTML = users.map(u => `
    <div data-id="${u.id}" class="p-2 rounded-lg bg-[color:var(--bg)] text-center card !shadow-none hover:!shadow-lg">
      <img src="${u.image}" alt="${u.name}" class="w-16 h-16 rounded-full mx-auto object-cover border-2 border-[color:var(--border)]">
      <div class="text-sm mt-2 font-semibold truncate">${u.name}</div>
      <div class="text-xs text-[color:var(--muted)]">Roll: ${u.roll}</div>
      <div class="flex gap-1 mt-2 justify-center">
        <button class="delete btn bg-red-600 text-white !p-1.5" data-id="${u.id}"><i class="fas fa-trash"></i></button>
        <button class="analytics btn bg-gray-600 text-white !p-1.5" data-id="${u.id}"><i class="fas fa-chart-pie"></i></button>
      </div>
    </div>
  `).join('');

  list.querySelectorAll('.delete').forEach(btn => btn.addEventListener('click', async (e)=>{
    const id = btn.dataset.id;
    if(await showConfirm('Are you sure you want to delete this student?')){ STATE.users = STATE.users.filter(s=>s.id!==id); saveDB(); rebuildMatcherForCurrentDivision(); renderUserList(); showAlert('Deleted','Student removed'); }
  }));

  list.querySelectorAll('.analytics').forEach(btn=> btn.addEventListener('click', (e)=>{
    const id = btn.dataset.id; showAnalytics(id);
  }));
}

/* ========= Webcam capture for adding user ========= */
let captureStream = null;
let lastSnapDataUrl = null;
async function startCapture(){
  document.getElementById('capture-area').classList.remove('hidden');
  const vid = document.getElementById('capture-video');
  try{
    captureStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }});
    vid.srcObject = captureStream;
    vid.onloadedmetadata = ()=> vid.play();
  }catch(e){
    console.error(e); showAlert('Camera Error','Cannot access the webcam.');
  }
}
function stopCaptureIfAny(){
  document.getElementById('capture-area')?.classList.add('hidden');
  const vid = document.getElementById('capture-video');
  if(captureStream){
    captureStream.getTracks().forEach(t=>t.stop());
    captureStream = null;
  }
  if(vid){
    vid.pause();
    vid.srcObject = null;
  }
}
function snapAndShow(){
  const vid = document.getElementById('capture-video');
  const c = document.getElementById('capture-canvas');
  c.width = vid.videoWidth; c.height = vid.videoHeight;
  c.getContext('2d').drawImage(vid,0,0,c.width,c.height);
  lastSnapDataUrl = c.toDataURL('image/jpeg', 0.9);
  showAlert('Captured','Image captured. Submit the form to add the student.');
}

/* ========= File & Image Utilities ========= */
function fileToDataURL(file){
  return new Promise((res,rej)=>{ const r = new FileReader(); r.onload = ()=> res(r.result); r.onerror = rej; r.readAsDataURL(file); });
}
function resizeImage(dataUrl, maxWidth) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const ratio = img.width / img.height;
      canvas.width = Math.min(img.width, maxWidth);
      canvas.height = canvas.width / ratio;
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      resolve(canvas.toDataURL('image/jpeg', 0.9));
    };
    img.onerror = reject;
    img.src = dataUrl;
  });
}

/* ========= Export / Import ========= */
function exportJSON(){
  const currentTeacher = getCurrentTeacher();
  const division = currentTeacher ? currentTeacher.division : null;
  // export only current division data for safety
  const payload = {
    users: STATE.users.filter(u => u.division === division),
    attendance: STATE.attendance.filter(a => a.division === division),
    timetable: STATE.timetable.filter(t => t.division === division)
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `attendwise_export_div${division}_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}
function importJSONFromFile(e){
  const f = e.target.files && e.target.files[0]; if(!f) return;
  const r = new FileReader(); r.onload = ()=>{
    try{
      const parsed = JSON.parse(r.result);
      if(Array.isArray(parsed.users) && Array.isArray(parsed.attendance)){
        // merge imported students into current division (imported users should include division)
        const currentTeacher = getCurrentTeacher();
        const division = currentTeacher ? currentTeacher.division : null;
        // ensure imported users get division if missing
        const importedUsers = parsed.users.map(u => ({ ...u, division: u.division || division }));
        // do not override other divisions
        STATE.users = STATE.users.concat(importedUsers);
        // imported attendance: keep only those matching division
        const importedAttendance = parsed.attendance.map(a => ({ ...a, division: a.division || division }));
        STATE.attendance = STATE.attendance.concat(importedAttendance);
        STATE.timetable = STATE.timetable.concat(parsed.timetable || []);
        saveDB(); rebuildMatcherForCurrentDivision(); renderUserList(); showAlert('Success','Database imported successfully.');
      } else showAlert('Invalid File','The JSON structure is not recognized.');
    }catch(err){ showAlert('Error','The selected file is not valid JSON.'); }
  };
  r.readAsText(f);
}

/* ========= Logs Page ========= */
function setupLogsPage(){
  document.getElementById('log-date').addEventListener('change', renderLogs);
  document.getElementById('download-csv').addEventListener('click', downloadCSV);
  document.getElementById('clear-attendance').addEventListener('click', async ()=> {
    const currentTeacher = getCurrentTeacher();
    if(!currentTeacher) return;
    if(await showConfirm('Clear all attendance records for your division? This cannot be undone.')){ STATE.attendance = STATE.attendance.filter(a => a.division !== currentTeacher.division); saveDB(); renderLogs(); showAlert('Cleared','All attendance records for your division have been cleared.'); }
  });
  renderLogs();
}
function renderLogs(){
  const date = document.getElementById('log-date').value;
  const currentTeacher = getCurrentTeacher();
  const rows = STATE.attendance.filter(a => a.date === date && a.division === currentTeacher.division);
  const tbody = document.getElementById('log-body');
  if(!rows.length){ tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-[color:var(--muted)]">No records found for this date.</td></tr>'; return; }
  tbody.innerHTML = rows.map(r => `<tr class="border-b border-[color:var(--border)]"><td class="p-2">${r.name}</td><td class="p-2">${r.date}</td><td class="p-2">${r.subject}</td><td class="p-2">${r.time}</td><td class="p-2">${r.status}</td></tr>`).join('');
}
function downloadCSV(){
  const date = document.getElementById('log-date').value;
  const currentTeacher = getCurrentTeacher();
  const rows = STATE.attendance.filter(a => a.date === date && a.division === currentTeacher.division);
  if(!rows.length){ showAlert('No Data','There is no data to download for the selected date.'); return; }
  const headers = ['Name','Date','Subject','Time','Status'];
  const csv = [headers.join(',')].concat(rows.map(r=>`"${r.name}","${r.date}","${r.subject}","${r.time}","${r.status}"`)).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `attendance_div${currentTeacher.division}_${date}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* ========= Timetable Page Logic ========= */
function setupTimetablePage(){
  renderTimetable();
  const form = document.getElementById('add-schedule-form');
  form.addEventListener('submit', (e) => {
    e.preventDefault();
    const subject = document.getElementById('tt-subject').value.trim();
    const day = document.getElementById('tt-day').value;
    const startTime = document.getElementById('tt-start-time').value;
    const endTime = document.getElementById('tt-end-time').value;
    const currentTeacher = getCurrentTeacher();
    if(!currentTeacher){ showAlert('Error','No teacher logged in'); return; }
    const division = currentTeacher.division;

    if(!subject || !day || !startTime || !endTime) { showAlert('Error', 'All fields are required.'); return; }
    if (startTime >= endTime) { showAlert('Error', 'Start time must be before end time.'); return; }

    const newEntry = { id: Date.now().toString(), subject, day, startTime, endTime, division };
    STATE.timetable.push(newEntry); saveDB(); renderTimetable(); form.reset();
  });
  document.getElementById('timetable-display').addEventListener('click', async (e) => {
    if (e.target.closest('.delete-tt-entry')) {
      const id = e.target.closest('.delete-tt-entry').dataset.id;
      if (await showConfirm('Delete this timetable entry?')) {
        STATE.timetable = STATE.timetable.filter(entry => entry.id !== id);
        saveDB(); renderTimetable(); showAlert('Deleted', 'Timetable entry removed.');
      }
    }
  });
}

function renderTimetable() {
  const display = document.getElementById('timetable-display');
  if (!display) return;
  const currentTeacher = getCurrentTeacher();
  const division = currentTeacher ? currentTeacher.division : null;
  const daysOfWeek = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  // select only entries for this division
  const entries = STATE.timetable.filter(t => t.division === division);
  entries.sort((a,b) => (a.day - b.day) || a.startTime.localeCompare(b.startTime));

  let html = '';
  const dayOrder = [1, 2, 3, 4, 5, 6, 0];
  dayOrder.forEach(dayIndex => {
    const dayEntries = entries.filter(entry => entry.day == dayIndex);
    html += `<div><h4 class="font-semibold border-b border-[color:var(--border)] pb-1 mb-2">${daysOfWeek[dayIndex]}</h4>`;
    if (dayEntries.length === 0) {
      html += `<div class="text-sm text-[color:var(--muted)] p-2">No classes scheduled.</div>`;
    } else {
      html += `<ul class="space-y-2">`;
      dayEntries.forEach(entry => {
        const formatTime = (time) => new Date(`1970-01-01T${time}`).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        html += `
          <li class="flex justify-between items-center text-sm p-2 rounded-md bg-[color:var(--bg)]">
            <div><strong>${entry.subject}</strong><div class="text-xs text-[color:var(--muted)]">${formatTime(entry.startTime)} - ${formatTime(entry.endTime)}</div></div>
            <button class="delete-tt-entry text-red-500 hover:text-red-400" data-id="${entry.id}"><i class="fas fa-trash-alt"></i></button>
          </li>
        `;
      });
      html += `</ul>`;
    }
    html += `</div>`;
  });
  display.innerHTML = html;
}

/* ========= Settings Page ========= */
function setupSettingsPage(){
  const form = document.getElementById('cred-form');
  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    const cur = document.getElementById('cur-pass').value;
    const np = document.getElementById('new-pass').value;
    const currentTeacher = getCurrentTeacher();
    if(!currentTeacher){ showAlert('Error','No teacher logged in'); return; }
    const teachers = JSON.parse(localStorage.getItem('teachers') || '[]');
    const found = teachers.find(t=>t.username === currentTeacher.username);
    if(!found){ showAlert('Error','Account not found'); return; }
    if(cur !== found.password){ showAlert('Error','Current password incorrect'); return; }
    if (!np) { showAlert('Error', 'New password cannot be empty.'); return; }
    found.password = np;
    localStorage.setItem('teachers', JSON.stringify(teachers));
    // update currentTeacher in storage
    const updated = { ...currentTeacher, password: np };
    localStorage.setItem('currentTeacher', JSON.stringify(updated));
    form.reset(); showAlert('Saved','Password updated');
  });

  document.getElementById('clear-users').addEventListener('click', async ()=>{
    const currentTeacher = getCurrentTeacher();
    if(!currentTeacher) return;
    if(await showConfirm('Delete all students in your division? This cannot be undone.')){ STATE.users = STATE.users.filter(u => u.division !== currentTeacher.division); saveDB(); rebuildMatcherForCurrentDivision(); showAlert('Cleared','All students in your division deleted'); showPage('users'); }
  });
}

/* ========= Clock / Recognition Page ========= */
function setupClockPage(){
  const startBtn = document.getElementById('start-btn');
  const stopBtn = document.getElementById('stop-btn');
  const pauseBtn = document.getElementById('pause-btn');

  startBtn.addEventListener('click', startSession);
  stopBtn.addEventListener('click', stopSession);
  pauseBtn.addEventListener('click', ()=> {
    if(STATE.recogInterval){ clearInterval(STATE.recogInterval); STATE.recogInterval = null; pauseBtn.textContent = 'Resume'; } else { runRecognition(); pauseBtn.textContent = 'Pause'; }
  });
}

async function startSession(){
  const currentTeacher = getCurrentTeacher();
  if(!currentTeacher){ showAlert('Error','No teacher logged in'); return; }
  // ensure there are students in this division
  const divisionStudents = STATE.users.filter(u => u.division === currentTeacher.division);
  if(!divisionStudents.length){ showAlert('No Students Registered','You must register students in your division before starting a session.'); return; }
  const subj = document.getElementById('subject').value.trim();
  if(!subj){ showAlert('Error','Subject name is required.'); return; }
  document.getElementById('active-subject').textContent = subj;
  document.getElementById('session-setup').classList.add('hidden');
  document.getElementById('session-run').classList.remove('hidden');
  await startVideoRecognition();
}

async function startVideoRecognition(){
  try{
    const vid = document.getElementById('video');
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }});
    vid.srcObject = stream; STATE.videoStream = stream;
    vid.onloadedmetadata = () => {
      vid.play();
      resizeOverlay();
      runRecognition();
    };
  }catch(e){
    console.error(e); showAlert('Camera Error','Could not access the camera.'); stopSession();
  }
}

function stopSession(){
  stopRecognition();
  document.getElementById('session-run').classList.add('hidden');
  document.getElementById('session-setup').classList.remove('hidden');
}

function stopRecognition(){
  if(STATE.recogInterval){
    clearInterval(STATE.recogInterval);
    STATE.recogInterval = null;
  }
  const vid = document.getElementById('video');
  if(STATE.videoStream){
    STATE.videoStream.getTracks().forEach(t=>t.stop());
    STATE.videoStream = null;
  }
  if(vid){
    vid.pause();
    vid.srcObject = null;
  }
  STATE.verifying = false;
  STATE.pendingUser = null;
}

function resizeOverlay(){
  const vid = document.getElementById('video'), canvas = document.getElementById('overlay');
  if(!vid || !canvas) return;
  canvas.width = vid.clientWidth;
  canvas.height = vid.clientHeight;
}

function runRecognition(){
  const vid = document.getElementById('video');
  const canvas = document.getElementById('overlay');
  const ctx = canvas.getContext('2d');
  STATE.recogInterval = setInterval(async ()=>{
    if(!STATE.videoStream || STATE.verifying) return;
    try{
      const detections = await faceapi.detectAllFaces(vid, tinyFaceDetectorOptions).withFaceLandmarks().withFaceDescriptors();
      if(!detections || !detections.length){ ctx.clearRect(0,0,canvas.width,canvas.height); return; }

      const resized = faceapi.resizeResults(detections, { width: canvas.width, height: canvas.height });
      ctx.clearRect(0,0,canvas.width,canvas.height);
      resized.forEach(det => {
        const box = det.detection.box;
        ctx.strokeStyle = '#3b82f6'; ctx.lineWidth = 2; ctx.strokeRect(box.x, box.y, box.width, box.height);
        if(STATE.faceMatcher){
          const best = STATE.faceMatcher.findBestMatch(det.descriptor);
          const label = best.label;
          const txt = label === 'unknown' ? 'Unknown' : `${label} (${Math.round(best.distance * 100)}%)`;
          ctx.fillStyle = 'rgba(0,0,0,0.6)';
          ctx.fillRect(box.x, box.y + box.height, box.width, 20);
          ctx.fillStyle = '#fff'; ctx.font = '14px sans-serif'; ctx.fillText(txt, box.x + 5, box.y + box.height + 15);
          if(label !== 'unknown') attemptVerify(label);
        }
      });
    }catch(e){
      console.error('Recognition error:', e);
    }
  }, 1200);
}

/* ---------- Verification / PIN ---------- */
function attemptVerify(name){
  const subj = document.getElementById('active-subject').textContent || '';
  const currentTeacher = getCurrentTeacher();
  if(!currentTeacher) return;
  const key = `${name}|${subj}|${currentTeacher.division}`;
  const now = Date.now();
  if(STATE.cooldownMap.has(key) && now - STATE.cooldownMap.get(key) < 30_000) return;
  const today = new Date().toISOString().slice(0,10);
  if(STATE.attendance.find(a=>a.name===name && a.date===today && a.subject.toLowerCase()===subj.toLowerCase() && a.division === currentTeacher.division)){
    appendLog(`${name} already clocked in for ${subj}`, 'text-[color:var(--muted)]'); STATE.cooldownMap.set(key, now); return;
  }
  if(STATE.verifying) return;
  STATE.pendingUser = STATE.users.find(u=>u.name === name && u.division === currentTeacher.division);
  if(!STATE.pendingUser) return;
  STATE.verifying = true;
  STATE.cooldownMap.set(key, now);
  els.pinName.textContent = name;
  els.pinInput.value = '';
  els.pinErr.textContent = '';
  els.pinModal.classList.remove('hidden');
  els.pinInput.focus();
  STATE.pinTimeout = setTimeout(()=>{ if(STATE.verifying) cancelPin(); }, 15_000);
}

function cancelPin(){
  STATE.verifying = false; STATE.pendingUser = null; els.pinModal.classList.add('hidden'); if(STATE.pinTimeout){ clearTimeout(STATE.pinTimeout); STATE.pinTimeout = null; }
}
async function submitPin(e){
  e.preventDefault();
  if(!STATE.pendingUser){ cancelPin(); return; }
  const v = els.pinInput.value.trim();
  if(v === STATE.pendingUser.roll){
    await markAttendance(STATE.pendingUser.name);
    cancelPin();
  } else {
    els.pinErr.textContent = 'Incorrect roll number';
    setTimeout(()=> els.pinErr.textContent = '', 1500);
    els.pinInput.value = '';
    els.pinInput.focus();
  }
}

/* ---------- Mark Attendance ---------- */
async function markAttendance(name){
  const now = new Date();
  const subj = document.getElementById('active-subject').textContent || '';
  const currentTeacher = getCurrentTeacher();
  const record = {
    id: Date.now().toString(), name, subject: subj,
    date: now.toISOString().slice(0,10),
    time: now.toLocaleTimeString(),
    status: 'Present',
    division: currentTeacher.division
  };
  STATE.attendance.push(record);
  saveDB();
  appendLog(`[${record.time}] ${name} - ${record.status}`, 'text-green-400');
}

function appendLog(msg, cls='text-[color:var(--muted)]'){
  const el = document.getElementById('recognition-log');
  if(!el) return;
  const d = document.createElement('div'); d.className = cls; d.textContent = msg;
  el.prepend(d);
  while(el.children.length > 40) el.removeChild(el.lastChild);
}

/* ========= Analytics & Dashboard Helpers ========= */
function showAnalytics(id){
  const user = STATE.users.find(u=>u.id === id); if(!user) return;
  const uAtt = STATE.attendance.filter(a=>a.name === user.name && a.division === user.division);
  const totalSessions = [...new Set(STATE.attendance.filter(a=>a.division === user.division).map(a=>a.date+'|'+a.subject))].length;
  const attended = [...new Set(uAtt.map(a=>a.date+'|'+a.subject))].length;
  const pct = totalSessions === 0 ? 'N/A' : `${((attended / totalSessions) * 100).toFixed(1)}%`;
  showAlert(`Analytics for ${user.name}`, `Division: ${user.division}\nAttendance: ${pct} (${attended} of ${totalSessions} total sessions)\n\nRecent Activity:\n${uAtt.slice(-5).reverse().map(a=>`• ${a.date} — ${a.subject}`).join('\n') || 'No records'}`);
}

function getCurrentClassInfo() {
  const currentTeacher = getCurrentTeacher();
  const division = currentTeacher ? currentTeacher.division : null;
  if (!division) return { text: 'No teacher logged in.', subject: null };
  if (STATE.timetable.length === 0) return { text: 'No schedule has been set up.', subject: null };
  const now = new Date();
  const day = now.getDay().toString();
  const currentTime = now.toTimeString().slice(0, 5);
  const todayClasses = STATE.timetable.filter(c => c.day === day && c.division === division).sort((a, b) => a.startTime.localeCompare(b.startTime));
  if (todayClasses.length === 0) return { text: 'No classes are scheduled for today.', subject: null };
  for (const c of todayClasses) {
    if (currentTime >= c.startTime && currentTime <= c.endTime) { return { text: `<strong>Ongoing:</strong> ${c.subject} (ends at ${c.endTime})`, subject: c.subject }; }
    if (currentTime < c.startTime) { return { text: `<strong>Next:</strong> ${c.subject} (starts at ${c.startTime})`, subject: c.subject }; }
  }
  return { text: 'All classes for today have finished.', subject: null };
}

/* ========= Misc ========= */
// Theme Toggle with persistence
function toggleTheme(){
  const html = document.documentElement;
  html.classList.toggle('light');
  const isLight = html.classList.contains('light');
  localStorage.setItem('theme', isLight ? 'light' : 'dark');

  // update icons
  document.querySelectorAll('#theme-toggle i, #theme-toggle-mobile i').forEach(i=>{
    i.className = isLight ? 'fas fa-sun' : 'fas fa-moon';
  });
}

// Load theme from storage on startup
document.addEventListener('DOMContentLoaded', () => {
  if(localStorage.getItem('theme') === 'light'){
    document.documentElement.classList.add('light');
  }
  // set correct icon on load
  const isLight = document.documentElement.classList.contains('light');
  document.querySelectorAll('#theme-toggle i, #theme-toggle-mobile i').forEach(i=>{
    i.className = isLight ? 'fas fa-sun' : 'fas fa-moon';
  });

  // add listeners
  document.getElementById('theme-toggle')?.addEventListener('click', toggleTheme);
  document.getElementById('theme-toggle-mobile')?.addEventListener('click', toggleTheme);
});

/* ========= Utilities: Export/Import + Misc ========= */
document.querySelectorAll('.nav-item').forEach(a=> a.addEventListener('click', e=>{ e.preventDefault(); showPage(a.dataset.page); }));

// Initial DB load and UI state set
loadDB();
checkAuthAndShow();

/* ============================
   End of script
   ============================ */
</script>

</body>
</html>
